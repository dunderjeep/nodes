<dom-module id="graph-view">

	<template>

		<style>

			.flex {
			 	display: flex;
			 	flex-direction: column;
			 	align-items: center;
			 	justify-content: center;
			}

			#svg {
				margin: 10px;
			}

			line {
				stroke: #999;
			 	stroke-width: 1px;
			}

			.node circle {
				r: 3;
				cursor: move;
				fill: black;
			}

			.node {
      	pointer-events: all;
      }

			.polygon {

			.polygons {
				fill: none;
				stroke: #999;
				pointer-events: all;
			}

			.active {
				fill: #aaaaaa;
				opacity: 0.1;
			}

			text {
				display: none;
			}

		</style>

		<div class="flex">
			<div id="svg"></div>
			<iron-icon icon="account-circle" on-tap="signOut"></iron-icon>
		</div>

	</template>

	<script>

		function Graph(el, graphView) {
		  // d3.select(window)
		  //   .on('resize', resize);

			var svg = d3.select(el)
        .append("svg")
        .attr("width", 500)
        .attr("height", 500)
        .attr("class", "svg")
        .on("dblclick", dblclick);

			var width = 500, height = 500;

			var simulation = d3.forceSimulation(graphView.nodes)
				.force("link", d3.forceLink().id(function(d) { return d.__firebaseKey__; }))
				.force("charge", d3.forceManyBody().strength(0))
				.force("center", d3.forceCenter(width / 2, height / 2))
				.on("tick", ticked);

			var link = svg.append("g").attr("class", "links").selectAll(".link"),
	      node = svg.append("g").attr("class", "nodes").selectAll(".node");
			var nodes = svg.append("g").attr("class", "nodes"),
			node = nodes.selectAll(".node"),
			links = svg.append("g").attr("class", "links"),
			link = links.selectAll(".link"),
			polygons = svg.append("g").attr("class", "polygons");

			var voronoi = d3.voronoi()
				.x(function(d) { return d.x; })
				.y(function(d) { return d.y; })
				.extent([[-1, 1], [width + 1, height + 1]]);

  		var update = function(){

				polygons.selectAll("polygon")
					.data(graphView.nodes)
					.enter().append("polygon")
					.on("mouseover", mouseover)
					.on("mouseout", mouseout)
					.call(d3.drag()
						.on("start", dragstarted)
						.on("drag", dragged)
						.on("end", dragended));

				node = nodes.selectAll("g").data(graphView.nodes); //UPDATE
				var nodeEnter = node.enter()
					.append("g")
					.attr("class", "node");
				nodeEnter.append("circle");
				nodeEnter.append("text")
					.text(function(d) { return d.__firebaseKey__; });
				nodeEnter.append("path").attr("class", "path");
				nodeEnter.call(d3.drag()
							 .on("start", dragstarted)
							 .on("drag", dragged)
							 .on("end", dragended));
				node = node.merge(nodeEnter);

				// link = link.data(graphView.links);
				// if (link.exit) link.exit().remove();
				// if (link.enter) {
				// 	link = link.enter().append("line")
				// 		.attr("class", "link")
				// 		.merge(link);

				node.merge(nodeEnter);

				node.call(d3.drag()
										.on("start", dragstarted)
										.on("drag", dragged)
										.on("end", dragended));

				link = links.selectAll(".link").data(graphView.links);
				if (link.enter) {
					link.enter().append("line")
						.attr("class", "link")
						.merge(link);

				}

				simulation.nodes(graphView.nodes);
				if (link.enter) simulation.force("link").links(graphView.links);
				simulation.restart();
			};

		  function resize() {
		    svg.attr("width", graphView.clientWidth)
		       .attr("height", graphView.clientHeight);
		  };

		  function dblclick() {
		    var point = d3.mouse(this);
		    graphView.push("nodes", { x: point[0], y: point[1]});
			}

			function mouseover(d) {
				d3.select(this).classed("active", true);
				d3.select(this).select(".node").classed("active", true);
			}

			function mouseout(d) {
				d3.select(this).classed("active", false);
			}

			function dragstarted(d) {
				//d3.select(this).raise().classed("active", true);
				if (!d3.event.active) simulation.alphaTarget(0.3).restart();
				d.fx = d.x;
				d.fy = d.y;
			}

			function dragged(d) {

				d3.select(this).select("g").attr("cx", d.fx = d3.event.x).attr("cy", d.fy = d3.event.y);

				//var what = d3.select(this).select("g").attr("cx", d.fx = d3.event.x).attr("cy", d.fy = d3.event.y);
				d.fx = d3.event.x;
				d.fy = d3.event.y;

			}

			function dragended(d) {
				//d3.select(this).classed("active", false);
				if (!d3.event.active) simulation.alphaTarget(0);
				d.fx = null;
				d.fy = null;
			}

			function ticked() {

				var diagram = voronoi.polygons(node.data());

				node.select("circle")
	        .attr("cx", function(d) { return d.x; })
	        .attr("cy", function(d) { return d.y; });

	      node.select("path")
	        .data(voronoi.polygons(diagram))
	        .attr("d", function(d) { return d == null ? null : "M" + d.join("L") + "Z"; });

	      node.select("text")
	        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" });

	      // link.attr("x1", function(d) { return d.source.x; })
	      //     .attr("y1", function(d) { return d.source.y; })
	      //     .attr("x2", function(d) { return d.target.x; })
	      //     .attr("y2", function(d) { return d.target.y; });

				polygons.selectAll("polygon")
					.attr("points", function(d, i) { return diagram[i]; });

				links.selectAll(".link")
				  .attr("x1",function(d) { return d.source.x; } )
				  .attr("y1", function(d) { return d.source.y; })
				  .attr("x2", function(d) { return d.target.x; })
				  .attr("y2", function(d) { return d.target.y; });

				node
				 	.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")" });
			}

			return {
			    svg: svg,
			    update: update
			}

		};

		Polymer({
		  is: 'graph-view',
		  properties: {
		    nodes: {
		      type: Array
		    },
		    links: {
		      type: Array
		    }
		  },

		  observers: ['_fBChanged(links.splices)', '_fBChanged(nodes.*)'],

		  _fBChanged: function(e) {
      	this.graph.update();
		  },

		  attached: function() {
		    this.graph = Graph(this.$.svg, this);
        this.scopeSubtree(this.$.svg, true);
		  },

		  signOut: function() {
		    this.fire('sign-out');
		  }

		});

	</script>
</dom-module>
