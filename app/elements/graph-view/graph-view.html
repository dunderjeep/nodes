<dom-module id="graph-view">

	<template>

		<style>

			.flex {
			 	display: flex;
			 	flex-direction: column;
			 	align-items: center;
			 	justify-content: center;
			}

			.link {
				stroke: #808080;
			 	stroke-width: 1px;
			}

			.node circle {
				r: 5;
				cursor: move;
				fill: black;
			}

			.svg {
				outline: thin solid black;
			}

			.cell {
      	pointer-events: all;
      }

		</style>

		<div class="flex">
			<h2>Nodes</h2>
			<div id="svg"></div>
			<iron-icon icon="account-circle" on-tap="signOut"></iron-icon>
		</div>

	</template>

	<script>

		function Graph(el, graphView) {

		  var width = 500, height = 500;

		  d3.select(window)
		    .on('resize', resize);

			var svg = d3.select(el)
			              .append("svg")
			              .attr("width", graphView.clientWidth * .9)
			              .attr("height", graphView.clientHeight)
			              .attr("class", "svg")
			              .on("dblclick", dblclick);

			var width = +svg.attr("width"), height = +svg.attr("height");

			var simulation = d3.forceSimulation(graphView.nodes)
						.force("link", d3.forceLink(graphView.links))
						.force("charge", d3.forceManyBody())
						.force("center", d3.forceCenter(width / 2, height / 2))
						.on("tick", tick);

			var nodes = svg.selectAll("g");
			var node = svg.selectAll(".circle");

			var update = function(){

				nodes = svg.selectAll("g")
					.data(graphView.nodes, function(d) { return d.__firebaseKey__; }).call(d3.drag()
						.on("start", dragstarted)
						.on("drag", dragged)
						.on("end", dragended));
				nodes = nodes.enter().append("g").attr("class", "node");
				nodes.append("circle").attr("class", "circle");
				nodes.append("text").text(function(d) { return d.__firebaseKey__; }).attr("class", "text");

				node = svg.selectAll("circle");

				nodes.exit().remove();

				simulation.nodes(graphView.nodes);
			};

		  function resize() {
		    svg.attr("width", graphView.clientWidth * .9)
		       .attr("height", graphView.clientHeight);
		  };

		  function dblclick() {
		    var point = d3.mouse(this);
		    graphView.push("nodes", { x: point[0], y: point[1]});
				console.log(point, graphView.nodes);
			}

			function dragstarted(d) {
				if (!d3.event.active) simulation.alphaTarget(0.3).restart();
				d.fx = d.x;
				d.fy = d.y;
			}

			function dragged(d) {
				d.fx = d3.event.x;
				d.fy = d3.event.y;
			}

			function dragended(d) {
				if (!d3.event.active) simulation.alphaTarget(0);
				d.fx = null;
				d.fy = null;
			}

			function tick() {
	      	nodes
						.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")" });
			}

			return {
			    svg: svg,
			    update: update
			}

		};

		Polymer({
		  is: 'graph-view',
		  properties: {
		    nodes: {
		      type: Array
		    },
		    links: {
		      type: Array
		    }
		  },

		  observers: ['_fBChanged(links.splices)', '_fBChanged(nodes.*)'],

		  _fBChanged: function(e) {
      	this.graph.update();
		  },

		  attached: function() {
		    this.graph = Graph(this.$.svg, this);
        this.scopeSubtree(this.$.svg, true);
		  },

		  signOut: function() {
		    this.fire('sign-out');
		  }

		});

	</script>
</dom-module>
